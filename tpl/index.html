<html>
<head>
    <link rel="stylesheet" type="text/css" href="http://dev.sencha.com/deploy/ext-4.0.0/resources/css/ext-all.css">

    <script type="text/javascript" charset="utf-8" src="http://dev.sencha.com/deploy/ext-4.0.0/ext-all-debug.js"></script>

</head>
<body>
<div id="example"></div>
<div id="editor-grid"></div>

<script>
    Ext.Loader.setConfig({
        enabled: true
    });
    Ext.Loader.setPath('Ext.ux', 'http://dev.sencha.com/deploy/ext-4.0.0/examples/ux');

    Ext.require([
        'Ext.selection.CellModel',
        'Ext.grid.*',
        'Ext.data.*',
        'Ext.util.*',
        'Ext.state.*',
        'Ext.form.*',
        'Ext.ux.CheckColumn'
    ]);

    Ext.onReady(function(){
//        Ext.QuickTips.init();


        Ext.define('Weapon', {
            extend: 'Ext.data.Model',
            fields: [
//                    'name_ja', 'category', 'durability', 'growthType', 'atk','rarity','skill1','skill2','skill3','name_en','userType'
                // the 'name' below matches the tag name to read, except 'availDate'
                // which is mapped to the tag 'availability'
                {name: 'name_ja', type: 'string',convert: null,     defaultValue: undefined},
                {name: 'name_en', type: 'string',convert: null,     defaultValue: undefined},
                {name: 'category'},
                {name: 'durability', type: 'int',convert: null,     defaultValue: undefined},
                {name: 'growthType', type: 'int',convert: null,     defaultValue: undefined},
//                // dates can be automatically converted by specifying dateFormat
                {name: 'atk', type: 'int',convert: null,     defaultValue: undefined}
            ]
        });


        function category(value){
            x = [[0,"Monster"],
                    [1,"Sword"],
                    [2,"BigSword"],
                    [3,"Katana"],
                    [4,"Knife"],
                    [5,"Bow"],
                    [6,"Spear"],
                    [7,"Rod"],
                    [8,"Book"]]
            return x[value][1];
        }


        // create the Data Store
        var store = Ext.create('Ext.data.Store', {
            model: 'Weapon',
            proxy: {
                type: 'ajax',
                url: 'testdata',
                reader: {
                    type: 'json',
                    root: 'data',
                    enums: 'enums',
                    reference: 'reference',
                    data_type:'data_type'
                },
                autoLoad: true
            }
//            sorters: [{
//                property: 'common',
//                direction:'ASC'
//            }]
        });
        console.log(store);

        var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
            clicksToEdit: 1
        });

        // create the grid and specify what field you want
        // to use for the editor at each header.
        var grid = Ext.create('Ext.grid.Panel', {
            store: store,
            columns: [{
                id: 'name_ja',
                header: '名前',
                dataIndex: 'name_ja',
                flex: 1,
                editor: {
                    allowBlank: false
                }
            },{
                header: '名前',
                dataIndex: 'name_en',
                flex: 1,
                editor: {
                    allowBlank: false
                }
            }, {
                header: 'Category',
                dataIndex: 'category',
                width: 130,
                renderer: category,
                field:{
                    xtype: 'combo',
                    typeAhead: true,
                    triggerAction: 'all',
                    selectOnTab: true,
                    store: [
                        [0,"Monster"],
                        [1,"Sword"],
                        [2,"BigSword"],
                        [3,"Katana"],
                        [4,"Knife"],
                        [5,"Bow"],
                        [6,"Spear"],
                        [7,"Rod"],
                        [8,"Book"]
                    ],
                    fields:['name', 'value'],
                    displayField:'value',
                    valueField:'name',
                    lazyRender: true,
                    listClass: 'x-combo-list-small'
                }
            }, {
                header: 'Durability',
                dataIndex: 'durability',
                width: 70,
                align: 'right',
                editor: {
                    xtype: 'numberfield',
                    allowBlank: false,
                    minValue: 0,
                    maxValue: 100000
                }
            }, {
                header: 'Growth Type',
                dataIndex: 'growthType',
                width: 95,
                editor: {
                    xtype: 'numberfield',
                    allowBlank: false,
                    minValue: 0,
                    maxValue: 100000
                }
            }, {
                header: 'ATK',
                dataIndex: 'atk',
                width: 95,
                editor: {
                    xtype: 'numberfield',
                    allowBlank: false,
                    minValue: 0,
                    maxValue: 100000
                }
            }],
            selModel: {
                selType: 'cellmodel'
            },
            renderTo: 'editor-grid',
            width: 600,
            height: 300,
            title: 'Edit Weapons?',
            frame: true,
            tbar: [{
                text: 'Add Weapon',
                handler : function(){
                    // Create a model instance
                    var r = Ext.create('Weapon', {
                        name_ja: '新武器',
                        category: 0,
                        durability: 0,
                        growthType: 0,
                        atk: 100
                    });
                    store.insert(0, r);
                    cellEditing.startEditByPosition({row: 0, column: 0});
                }
            }],
            plugins: [cellEditing]
        });

        // manually trigger the data store load
        store.load({
            // store loading is asynchronous, use a load listener or callback to handle results
            callback: function(){
                console.log(store);
                Ext.Msg.show({
                    title: 'Store Load Callback',
                    msg: 'store was loaded, data available for processing',
                    modal: false,
                    icon: Ext.Msg.INFO,
                    buttons: Ext.Msg.OK
                });
            }
        });
    });

</script>
</body>
</html>